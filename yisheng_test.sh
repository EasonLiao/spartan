#/bin/bash

set -x

test_case=$1
profile_worker=0
profile_master=0
dump_timer=0
assign_mode=BY_CORE
log_level=WARN
cluster=1
worker_list=$2

tile_assignment_strategy=round_robin
default_rpc_timeout=3000000


hosts=172.31.0.128:2,172.31.10.25:2,172.31.3.30:2,172.31.10.236:2,172.31.7.246:2,172.31.7.93:2,172.31.2.142:2,172.31.1.130:2,172.31.6.227:2,172.31.5.179:2,172.31.12.39:2,172.31.10.106:2,172.31.1.254:2,172.31.7.238:2,172.31.10.23:2,172.31.5.171:2,172.31.2.111:2,172.31.13.168:2,172.31.9.98:2,172.31.6.26:2,172.31.14.190:2,172.31.1.172:2,172.31.11.154:2,172.31.13.76:2,172.31.6.32:2,172.31.2.212:2,172.31.14.199:2,172.31.1.61:2,172.31.11.99:2,172.31.15.4:2,172.31.11.132:2,172.31.7.223:2,172.31.15.169:2,172.31.8.90:2,172.31.11.28:2,172.31.11.159:2,172.31.15.2:2,172.31.9.111:2,172.31.3.171:2,172.31.5.154:2,172.31.1.90:2,172.31.9.197:2,172.31.3.99:2,172.31.7.141:2,172.31.7.12:2,172.31.5.130:2,172.31.5.7:2,172.31.12.18:2,172.31.8.115:2,172.31.10.60:2,172.31.5.233:2,172.31.4.67:2,172.31.8.29:2,172.31.10.28:2,172.31.5.253:2,172.31.15.111:2,172.31.12.131:2,172.31.15.100:2,172.31.10.212:2,172.31.10.119:2,172.31.1.114:2,172.31.8.183:2,172.31.4.81:2,172.31.2.219:2,172.31.3.138:2,172.31.1.118:2,172.31.10.54:2,172.31.10.228:2,172.31.14.108:2,172.31.7.236:2,172.31.8.4:2,172.31.15.16:2,172.31.5.106:2,172.31.14.37:2,172.31.13.216:2,172.31.2.236:2,172.31.14.163:2,172.31.1.163:2,172.31.1.224:2,172.31.15.214:2,172.31.10.59:2,172.31.0.153:2,172.31.15.128:2,172.31.10.99:2,172.31.9.130:2,172.31.5.12:2,172.31.11.206:2,172.31.14.40:2,172.31.8.128:2,172.31.13.175:2,172.31.5.178:2,172.31.9.174:2,172.31.9.248:2,172.31.12.40:2,172.31.4.169:2,172.31.12.226:2,172.31.2.238:2,172.31.9.216:2,172.31.2.151:2,172.31.5.230:2,172.31.4.145:2,172.31.11.72:2,172.31.0.189:2,172.31.1.4:2,172.31.11.143:2,172.31.12.99:2,172.31.10.104:2,172.31.4.180:2,172.31.7.53:2,172.31.15.135:2,172.31.13.21:2,172.31.1.78:2,172.31.0.110:2,172.31.2.244:2,172.31.3.61:2,172.31.9.246:2,172.31.12.75:2,172.31.12.12:2,172.31.7.164:2,172.31.8.87:2,172.31.5.139:2,172.31.7.188:2,172.31.8.72:2,172.31.4.25:2,172.31.2.82:2,172.31.0.130:2,172.31.15.250:2,172.31.3.157:2

function kill_all_python_process {
    killall -uchenqi python;
    machines=`echo $hosts | awk '{split($1, s, ",");for(i=1;i<=length(s);i++) {split(s[i], t, ":");print t[1]}}'`
    for machine in $machines
    do
        echo "$machine"
        ssh $machine -f "killall -uchenqi python;ps -uchenqi | grep python;"
    done
}

python $test_case --hosts=$hosts --port_base=40000 --cluster=$cluster --worker_list=$worker_list --dump_timer=$dump_timer --use_threads=0 --num_workers=$worker_list --assign_mode=$assign_mode --tile_assignment_strategy=$tile_assignment_strategy --default_rpc_timeout=$default_rpc_timeout --profile_worker=$profile_worker --profile_master=$profile_master --log_level=$log_level
